{% extends 'base.html' %}
{% load static %}
{% load render_proof %}
{% block meta %}

{% endblock %}
{% block title %}

{% endblock %}
{% block css %}
  <link rel="stylesheet" href="{% static 'css/tasks/view_task_details.css' %}" />
{% endblock %}
{% block content %}
  <section class="container py-5">
    <div class="mb-3">
      <a href="{% url 'user_task_overview' %}" class="btn btn-link p-0 text-decoration-none"><i class="bi bi-arrow-left-circle-fill me-2 align-middle"></i> Back to Overview</a>
    </div>

    <div class="row g-4">
      <!-- Details -->
      <div class="col-lg-7">
        <article class="card">
          <div class="card-body">
            <h1 class="h3 mb-3">Task Details</h1>
            <h2 class="h4 mb-2">{{ task.title }}</h2>

            <dl class="row">
              <dt class="col-sm-5">Description</dt>
              <dd class="col-sm-7">{{ task.description }}</dd>

              <dt class="col-sm-5">Checkup Interval</dt>
              <dd class="col-sm-7">{{ task.interval }}</dd>

              <dt class="col-sm-5">Fee for Failure</dt>
              <dd class="col-sm-7">{{ task.fee }}â‚¬</dd>

              <dt class="col-sm-5">Points for Completion</dt>
              <dd class="col-sm-7">{{ task.points }} Points</dd>

              {% if task.completed == True %}
                <dt class="col-sm-5">Task done successfully</dt>
                <dd class="col-sm-7">Yes</dd>
              {% endif %}
            </dl>
          </div>
        </article>
      </div>

      <!-- Proof & Actions -->
      <div class="col-lg-5">
        {% if not perms.tasks.mark_done %}
          <section class="card">
            <div class="card-body">
              <h3 class="h5 mb-3">Upload Proof</h3>
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {# Comments #}
                <div class="mb-3">
                  <label for="{{ check_form.comments.id_for_label }}" class="form-label">Comments:</label>
                  {{ check_form.comments }}
                  {% if check_form.comments.errors %}
                    <div class="invalid-feedback d-block">{{ check_form.comments.errors|striptags }}</div>
                  {% endif %}
                </div>

                {# Image upload: "Text: [Button]" #}
                <div class="mb-3">
                  <label for="{{ check_form.image.id_for_label }}" class="form-label">{{ check_form.image.help_text|default:'Upload an image for this checkup' }}:</label>
                  {{ check_form.image }}
                  <div class="form-text">{{ check_form.image.label }}</div>
                  {% if check_form.image.errors %}
                    <div class="invalid-feedback d-block">{{ check_form.image.errors|striptags }}</div>
                  {% endif %}
                </div>

                {# Text file upload: "Text: [Button]" #}
                <div class="mb-3">
                  <label for="{{ check_form.text_file.id_for_label }}" class="form-label">{{ check_form.text_file.help_text|default:'Upload a text file for this checkup' }}:</label>
                  {{ check_form.text_file }}
                  <div class="form-text">{{ check_form.text_file.label }}</div>
                  {% if check_form.text_file.errors %}
                    <div class="invalid-feedback d-block">{{ check_form.text_file.errors|striptags }}</div>
                  {% endif %}
                </div>

                {# Audio upload: "Text: [Button]" #}
                <div class="mb-3">
                  <label for="{{ check_form.audio_file.id_for_label }}" class="form-label">{{ check_form.audio_file.help_text|default:'Upload an audio file for this checkup' }}:</label>
                  {{ check_form.audio_file }}
                  <div class="form-text">{{ check_form.audio_file.label }}</div>
                  {% if check_form.audio_file.errors %}
                    <div class="invalid-feedback d-block">{{ check_form.audio_file.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="d-grid d-sm-flex gap-2">
                  <button type="submit" name="proof_upload" class="btn btn-primary">Upload proof</button>
                </div>
              </form>
            </div>
          </section>
        {% endif %}

        {% if perms.tasks.mark_done %}
          <section class="card">
            <div class="card-body">
              {% if task_checkup.comments %}
                <h4 class="h6 mb-2">Comments</h4>
                <p class="mb-3">{{ task_checkup.comments }}</p>
              {% endif %}

              {% if task_checkup.image %}
                <h4 class="h6 mb-2">Uploaded proof Image</h4>
                <div class="mb-3">{{ task_checkup.image|render_image }}</div>
              {% endif %}

              {% if task_checkup.text_file %}
                <h4 class="h6 mb-2">Uploaded proof Text File</h4>
                <div class="mb-3">{{ task_checkup.text_file|render_textfile }}</div>
              {% endif %}

              {% if task_checkup.audio_file %}
                <h4 class="h6 mb-2">Uploaded proof Audio File</h4>
                <div class="mb-3">{{ task_checkup.audio_file|render_audio }}</div>
              {% endif %}

              <p class="mb-3">Task Checkup Status: {{ task_checkup.completed|yesno:'Completed,Not Completed' }}</p>

              <form method="post">
                {% csrf_token %}
                <div class="d-grid d-sm-flex gap-2">
                  <button type="submit" name="done_checkbox" class="btn btn-primary">Mark as Done</button>
                </div>
              </form>
            </div>
          </section>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
