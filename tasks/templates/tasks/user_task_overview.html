{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}
  {% trans "Task Overview" %}
{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/tasks/user_task_overview.css' %}" />
{% endblock %}

{% block content %}
  {% if not subscription and not perms.tasks.mark_done %}
    <section class="container py-3 no-subscription">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="p-4 p-md-5 mb-4">
            <h1 class="h3 mb-2 no-subscription">{% trans "No active subscription" %}</h1>
            <p class="text-muted mb-4">{% trans "To use this feature and add tasks, you need an active subscription." %}</p>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <a href="{% url 'subscription_view' %}" class="btn btn-outline-secondary btn-lg" aria-label="{% trans 'subscriptions' %}">{% trans 'Subscriptions' %}</a>
              <a href="{% url 'faq' %}" class="btn btn-link" aria-label="{% trans 'FAQ' %}">{% trans 'Questions? Look at our FAQ' %}</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  {% else %}
    <section class="container py-3">
      <header class="d-flex align-items-center justify-content-between mb-4">
        <div>
          <h1 class="h2 mb-0">
            {% trans "Task" %}{% if perms.tasks.has_perm %}
              {% trans "Checkup" %}
            {% else %}
              {% trans "Overview" %}
            {% endif %}
          </h1>
          {% if not perms.tasks.mark_done %}
            <div>
              <p class="text-muted mb-0">
                {% trans "Your Task Slots:" %} <span>{{ open_tasks_count }}/{{ subscription.tasks_quota }}</span>
              </p>
              <p class="text-muted">
                {% trans "Your current points:" %} <span>{{ user_points.points }}</span>
              </p>
            </div>
          {% endif %}
        </div>

        {% if not perms.tasks.mark_done %}
          <div class="d-flex align-items-center flex-column">
            <a href="{% url 'add_task' %}" class="btn btn-primary {% if not can_add_task %}disabled{% endif %}" aria-label="{% trans 'Add Task' %}">{% trans 'Add Task' %}</a>
            {% if tasks_with_fee.count >= 1 %}
              <p class="text-muted mt-2">{% trans 'You can not add tasks until you paid your fees' %}</p>
            {% elif not can_add_task %}
              <p class="text-muted mt-2">{% trans 'You have reached your task limit.' %}</p>
            {% endif %}
          </div>
        {% endif %}
      </header>
      <section class="mb-5" aria-labelledby="Page description">
        <p class="text-muted">{% trans "Here you can see an overview of your tasks. You can add new tasks, see tasks that are in checkup, and tasks that are done. If a task is not done in time, a fee will be charged to your account." %}</p>
      </section>
      <!-- Open / Undone -->
      {% if not perms.tasks.mark_done %}
        <section class="mb-5" aria-labelledby="open-tasks">
          <h2 id="open-tasks" class="h4 mb-3">{% trans "Open Tasks" %}</h2>
          {% if tasks_undone %}
            <div class="row row-cols-1 row-cols-md-2 g-4">
              {% for task in tasks_undone %}
                <div class="col">
                  {% include 'tasks/_task_card.html' with task=task %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info mb-0" role="alert">{% trans "You have no current tasks." %}</div>
          {% endif %}
        </section>
      {% endif %}

      {% if task_to_check.count == 0 and perms.tasks.mark_done %}
        <div class="alert alert-info mb-0" role="alert">{% trans "No tasks in checkup." %}</div>
      {% endif %}

      {% comment %}Task to Check{% endcomment %}
      {% if task_to_check %}
        <section class="mb-5" aria-labelledby="open-tasks">
          <h2 id="open-tasks" class="h4 mb-3">{% trans "Tasks in Checkup" %}</h2>
          <div class="row row-cols-1 row-cols-md-2 g-4">
            {% for task in task_to_check %}
              <div class="col">
                {% include 'tasks/_task_card.html' with task=task %}
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% comment %}Fees to pay{% endcomment %}
      {% if tasks_with_fee and tasks_with_fee.count > 0 %}
        <section class="mb-5" aria-labelledby="fees-to-pay">
          <h2 id="fees-to-pay" class="h4 mb-3">{% trans "Fees to Pay" %}</h2>
          {% if tasks_with_fee and tasks_with_fee.count > 0 %}
            <div class="d-flex justify-content-end mb-2">
              <a class="btn btn-warning" href="{% url 'pay_all_fees' %}">{% trans "Pay all fees at once" %}</a>
            </div>
            <div class="row row-cols-1 row-cols-md-2 g-4">
              {% for task in tasks_with_fee %}
                <div class="col">
                  {% include 'tasks/_task_card.html' with task=task %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info mb-0" role="alert">{% trans "No fee to pay." %}</div>
          {% endif %}
        </section>
      {% endif %}
      <!-- Done -->
      {% if not perms.tasks.mark_done %}
        <section aria-labelledby="done-tasks">
          <h2 id="done-tasks" class="h4 mb-3">{% trans "Done Tasks" %}</h2>
          {% if tasks_done and tasks_done.count > 0 %}
            <div class="row row-cols-1 row-cols-md-2 g-4">
              {% for task in tasks_done %}
                <div class="col">
                  {% include 'tasks/_task_card.html' with task=task %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-secondary mb-0" role="alert">{% trans "No tasks completed yet." %}</div>
          {% endif %}
        </section>
      {% endif %}
    </section>
  {% endif %}
{% endblock %}
