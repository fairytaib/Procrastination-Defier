{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}
{% block title %}
  {{ post.title }}
{% endblock %}
{% block css %}
  <link rel="stylesheet" href="{% static 'css/blog_posts/post_details.css' %}" />
{% endblock %}

{% block content %}
  <section class="container py-5">
    <div class="mb-3">
      <a href="{% url 'blog_posts' %}" class="btn btn-link p-0 text-decoration-none"><i class="bi bi-arrow-left-circle-fill me-2 align-middle"></i> {% trans "Back to Posts" %}</a>
    </div>

    <article class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div>
          <h1 class="h2 mb-3">{{ post.title }}</h1>
          <p class="text-body-secondary mb-4">{% trans "By" %} {{ post.author.username }} {% trans "on" %} {{ post.created_at|date:"F j, Y" }}</p>
          <div class="text-body">{{ post.content }}</div>
        </div>

        {% comment %}Delete Button{% endcomment %}
        {% if user == post.author %}
          <div class="d-flex justify-content-end align-items-center gap-3 mt-1">
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePostModal"><i class="bi bi-trash3-fill"></i></button>
            <div class="modal fade" id="deletePostModal" tabindex="-1" aria-labelledby="deletePostLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deletePostLabel">{% trans "Delete post?" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>

                  <div class="modal-body">
                    <p class="mb-0">
                      {% trans "Are you sure you want to delete" %}
                      <strong>{{ post.title }}</strong>? {% trans "This action cannot be undone and there will be no points awarded." %}
                    </p>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>

                    <form method="post" action="{% url 'delete_post' post.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger">{% trans "Yes, delete" %}</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </article>

    <section aria-labelledby="comments-title" class="mb-4">
      <h2 id="comments-title" class="h4 mb-3">{% trans "Comments" %}</h2>

      {% if comments %}
        <div class="list-group mb-4">
          {% for comment in comments %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>{{ comment.author.username }}</strong>
                  <div class="small text-body-secondary">{{ comment.created_at }}</div>
                </div>
              </div>
              <p class="mb-0 mt-2">{{ comment.content }}</p>
              <div>
                {% if user == post.author %}
                  <div class="d-flex justify-content-end align-items-center gap-3 mt-1">
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal"><i class="bi bi-trash3-fill"></i></button>
                    <div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-labelledby="deleteCommentLabel" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                          <div class="modal-header">
                            <h5 class="modal-title" id="deleteCommentLabel">{% trans "Delete comment?" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>

                          <div class="modal-body">
                            <p class="mb-0">{% trans "Are you sure you want to delete your comment? This action cannot be undone and there will be no points awarded." %}</p>
                          </div>

                          <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>

                            <form method="post" action="{% url 'delete_comment' comment.id %}">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-danger">{% trans "Yes, delete" %}</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-secondary" role="alert">{% trans "No comments yet." %}</div>
      {% endif %}
    </section>

    {% if user.is_authenticated %}
      <section aria-labelledby="add-comment-title">
        <h3 id="add-comment-title" class="h5 mb-3">{% trans "Add a comment" %}</h3>
        <form method="POST" class="card border-0 shadow-sm">
          <div class="card-body">
            {% csrf_token %}
            {{ form|crispy }}
            <div class="d-grid d-sm-flex gap-2">
              <button type="submit" class="btn btn-primary">{% trans "Post comment" %}</button>
            </div>
          </div>
        </form>
      </section>
    {% else %}
      <a href="{{ login_url }}" class="btn btn-primary" aria-label="Create Post">{% trans "Login to leave a comment" %}</a>
    {% endif %}
  </section>
{% endblock %}
